\newpage

\begin{CJK*}{GBK}{song}

\setcounter{chapter}{2}
\setcounter{section}{0}

\chapter{计算广告基础}

\thispagestyle{empty}
\markboth{计算广告基础}{计算广告基础}

通过上一章的介绍，大家应该对在线广告业务上的本质和市场发展脉络有了初步的认识。本章的重点，是介绍在线广告中计算到底是为了解决哪些问题，以及解决这些问题所需要的系统框架与算法基础知识。

在互联网广告中，计算之所以可以发挥巨大的作用，与它的一些根本技术特点有很大关系，这也正是本章的出发点。总的来说，可衡量的效果以及相应的计算优化，是在线广告区别于线下广告的主要特点。在这些特色的基础上，我们对Andrei Broder提出的计算广告核心挑战稍作推广，得到贯穿本书的计算广告核心问题，即ROI优化问题的概念性框架表达。这一框架除了可以生发后面许多的计算和系统问题，还对在线广告市场结构和计费方式的一致理解很有帮助，我们在本章中对后一点着重做了展开讨论。

我们将会看到，在线广告多种多样的计费方式，实际上反映着市场结构的分工不同：具体来说，与供给方和需求方如何分工估计点击率和点击价值，从而完成整个市场的资源优化配置有关。对若干常见计费方式的深入理解，对于把握计算广告领域的核心问题，和评估每个问题在特定情形下的困难程度，有着非常重要的指导意义，也对于各种在线广告产品形态的把握有很大帮助。

为了方便后免各章的内容展开，特别是各种广告产品中的系统架构和算法讨论，我们在本章中将进行两方面的准备工作：首先，我们给出一个示意性的广告系统统一架构，虽然这一架构的各个组成模块在不同的广告产品中各有取舍和变形，却十分有利于我们从宏观上把握广告系统的全貌和各种产品在技术方面的内在联系。后文各种广告产品的架构讨论，都会在这个统一框架的基础上进行。其次，我们对计算广告中广泛使用的一些基础知识，如信息检索、最优化方法、统计及其学习等，作提纲挈领式的简要介绍。这样的是为了在后文讨论到相关算法时，可以有相对统一的展开基础，并避免在广告专门算法的讨论上穿插过大篇幅的基础内容。如果读者对某部分得知市已有相当的基础，则可以不做详细阅读，只简单了解本书的一些惯例数学表达；如果觉得某部分需要深入了解，那么还需要根据本章的简要提纲，参照其他专门文献，以获得更全面和深入的内容。

\section{互联网广告的技术特点}
从上一章的在线广告简史中，大家肯定已经发现了不少在线广告不同于传统广告的特点。在这些不同点当中，有一些对我们正确理解在线广告市场，对该市场的效果优化探究合适的解决方案，有着非常重要的指导意义。我们把这些重要特点总结出来，以便引出计算广告的核心问题与框架。

一、技术和计算导向。数字媒体的特点使在线广告可以进行精细的受众定向，技术又使得广告决策和交易朝着计算驱动的方向发展。之所以有这一特点，我们才会在这里讨论煞有介事地计算广告。实际上，受众定向这一思想在线下广告中也曾经被尝试过，比如试图把信用卡纸质帐单背面的广告按照信用卡用户的年龄和性别做一些定制化，不过由于非数字的媒体上这么做的成本太高，因而无法规模化。在数字媒体上进行受众定向，其成本可以控制得非常低，这也直接催生了在线广告的计算革命。除了受众定向，由于在线广告中独特拍卖性质的市场的存在，对于广告效果精确的预估和优化能力也是非常重要的。可以说，从来没有任何传统广告形式象在线广告那样，需要大规模地收集并利用数据，而这正是在线广告最吸引人之处。

二、效果的可衡量性。在线广告刚刚产生的时候，大家对这种广告最多的称道之处，是它可以以展示和点击日志的形式直接记录广告效果。当然，我们也可以利用这些日志优化广告效果，这同样是计算广告非常重要的方法论。不过，点击率这一指标从是否在绝对意义上能够反映广告效果，个人认为值得探讨。从98年到今天，条幅显示广告的点击率从10\%逐渐降低到降至0.1\%，难道这说明广告的效果下降了两个数量级么？快速增长的显示广告市场规模显然给出了否定的回答。我们认为，在同一个时期，点击率的绝对值并没有那么重要，而在一个特定时期不同广告和算法表现出来的差异，才是更有意义的。从这一点来看，可衡量性仍然可以认为是在线广告的一个根本特点。

三、创意和投放方式的标准化。标准化的驱动力来自于受众定向与程序购买。既然需求方关心的是人群而非广告位，创意尺寸的统一化与一些关键接口的标准化非常关键。这些接口标准中，比较典型的有上一章中介绍的视频广告的VAST标准和实时竞价的Open RTB标准等。实践表明，有越来越多的广告产品和平台愿意根据这些市场标准来设计自己的规范和接口，因为这样大家可以充分利用整个市场的流动性，更快地创造更多的价值。

四、媒体概念的多样化。随着Web 2.0的普及，赋予了更多交互功能的互联网媒体与线下媒体有大有不同。随着交互功能的不同，这些媒体与转化行为的距离也就不同。举个例子，对在线购物行业而言，门户网站、垂直网站、搜索引擎、电商网站、返利网，在转化链条上一个比一个更靠近购买行为。我们从直观就可以知道，越接近需求方的媒体上的广告，其带来的流量一定可以达到越高的ROI，不过离“引导潜在用户”这样的广告目的也就越远。因此我们在从需求方看在线广告时，应该注重各种性质媒体的配合关系，并从整合营销的角度去审视和优化整体的效果。试想，如果一家电商只用返利网作为线上广告渠道，ROI一定可以做到很高，可是返利网能给他带来潜在用户么？\footnote{2012年底，淘宝发布声明，宣布中止与以现金形式返利的淘宝客网站的合作，正是反映了市场对此问题的认知正在趋向一致和理性。}

五、数据驱动的投放决策。与工业革命时期机器化的根本驱动力――电力相类比，互联网化的根本驱动力可以认为是数据的深入加工和利用。这一点在大数据概念被广泛认知的今天已经成为老生常谈。前面提到的在线广告的计算技术，在很大程度上也要依赖于对于数据的大规模利用。广泛收集用户的行为数据和广告反馈数据，利用云计算的基础设施对用户打上合适的标签，同样根据数据在多个广告竞争同一次展示时作出决策，再将投放的结果统计数据反馈给广告操作人员以调整投放策略。已经成为在线广告的基本投放逻辑。因此，现代的在线广告系统，可以认为就是一个大数据处理平台，而且其对数据处理的规模和响应速度的要求都相当高。从这个意义上讲，在线广告是互联网业务中技术含量较高的产品之一。

\section{计算广告的核心问题}

Andrei Broder在提出计算广告这一概念的时候，同时也给出了该课题的核心研究挑战(注意是“挑战”而不是“定义”)。这一核心挑战，他的表述是“Find the best match between a given user, a given context, and a suitable ad”。我们结合近年来市场的发展以及实际业务中的一些体会，对此表述稍做加工如下，给出计算广告的核心问题如下：

\begin{CJK*}{GBK}{kai}计算广告的核心问题，是为一系列用户与环境的组合，找到最合适的广告投放策略以优化整体的投入产出比(ROI)。\end{CJK*}

与Andrei Broder的表述相比较，我们主要进行的两方面的微调：一、我们强调广告问题优化的是一组展示上的效果，而非孤立的某一次展示上的效果。这是由于广告活动中普遍存在着量的约束，在这一约束下进行ROI优化，其最优解往往与每次展示独立决策时有很大的不同；二、描述中去掉了“given"的字眼，这是由于在某些广告产品中，系统并不一定能拿到确定的用户或上下文唯一标识，但这并不意味着完全无法进行计算优化。同样地，我们也强调优化的结果是“广告投放策略”而不一定是具体的广告，这也是因为有些产品的策略并不是直接决定最后的展示。这些看来古怪的咬文嚼字，其实只是做一个铺垫，相信读完本书后面的部分，大家就能更深入地体会做这些调整的原因。

\subsection{投资回报率的数学表达}
对这一核心挑战，可以概念上表达为下面的最优化问题：
\begin{equation}\label{opt}
\max_{a_{1,\cdots,T}}\sum_{i=1}^T r(a_i, u_i, c_i) \bigg / \sum_{i=1}^T p_i
\end{equation}

表达式中的$a, u, c$三个变量，分别代表广告、用户与上下文，即广告活动的三个参与主体。$i$代表从第1次到第$T$次之间的某一次广告展示。我们优化的目标，就是在这$T$次展示上的总产出($r$)与总投入($p$)的比，即ROI。注意这里有一个隐含的假设，即整体的ROI可以被分解到每次展示上。这一假设显然是不太合理的，但是考虑到实际线上决策时，必须对每个展示马上完成计算，所以从实用出发我们仍然采用这一假设。在实际的系统中，我们会采用频次特征之类的方法解决展示之间相关性的问题。

下面我们再来看看ROI表达式进一步的分解方式，以便引出关于在线广告市场上若干主流计费方式的重要讨论。对一个广告市场中具体的产品形态而言，我们往往能够主动优化的是产出(return)而非投入(investment)的部分，因此，我们主要关注回报的部分。在一次广告展示产生后，有可能发生哪些后续行为呢？首先是点击，这是在媒体网站上发生的；然后是转化，这是在广告主网站上或线下发生的。按照点击和转化两个阶段对回报$r$进行分解，是实践中比较合理且容易操作的方式：
\begin{equation}
r(a, u, c) = \mu(a, u, c) \cdot \nu(a, u)
\end{equation}
在后文中，我们都沿用这样的符号表示：用$\mu$表示\begin{CJK*}{GBK}{kai}{点击率(Click through Rate, CTR)}\end{CJK*}，用$\nu$表示\begin{CJK*}{GBK}{kai}{点击价值(Click Value)}\end{CJK*}，而这两部分的乘积，即定量地表示了某次或若干次展示的期望CPM值，我们称之为expected CPM(eCPM)\footnote{由于CPM是千次展示的收益，因此eCPM实际上还要乘以1000才能与其相比较，为了表达简单起见，我们在本书中略去1000这一固定系数。}。请大家特别关注eCPM 这个指标，因为它是计算广告中最常被提及，也最有代表性的定量评估收益的指标，本书中有大量的计算问题都是围绕它展开的。实际上，点击价值是还可以进一步分解的，比如对于在线购物的网站，我们可以将点击价值进一步分解为到达率、\begin{CJK*}{GBK}{kai}{转化率(Conversion Rate)}\end{CJK*}和客单价的乘积。不过这部分的深入解剖与行业密切相关，而且更多地属于站内运营而非广告的范畴，因此在本书中将制作简要的讨论。与这里的分析相对应，我们认为点击率是$(a,u,c)$三者的函数，而转化率可以近似为$(a,c)$的函数。

\subsection{付费模式产生的原因――谁来估计展示价值}
对于大多数广告产品而言，对需要得到给定$(a, u, c)$三元组的eCPM以便进行决策。可是由于广告市场的协作关系复杂，并非每个广告产品都可以对eCPM中的两部分做出较准确的估计。根据eCPM的分解决定哪部分由谁来估计，是广告市场各种计费模式产生的根本原因。我们来看一下三种主要的计费模式：

一、CPM(Cost per Mille)计费，即按照千次展示计费，这里的“mille”是拉丁文“千次”的意思。这种方式，是供给方与需求方约定好千次展示的计费标准，至于这些展示是否能够带来相应的收益，由需求方来估计和控制其中的风险。对于品牌广告，由于目标是较长时期内的利益，很难通过对短期数据进行分析的方式直接计算点击价值，而点击率也因为对于用户接触的核心要求变得不是唯一重要的因素。在这种情况下，由需求方自行根据其市场策略与预算控制单位流量的价格并按CPM方式计费，是比较合理的交易模式。

二、CPC(Cost per Click)计费，即按点击计费。这种方式最早产生于搜索广告，并很多为大多数效果广告网络所普遍采用。这种方式是把点击率的估计交给供给方(或者中间市场)，而把点击价值的估计交给需求方，而需求方通过出价的方式向市场通知自己的估价\footnote{当然需求方不会完全按照其点击价值来出价，而是会寻求更低的价格以获得套利空间。因此，如何在市场机制上避免广告主积极地调整出价，以促进市场竞争的激烈程度，是竞价体系设计的关键。我们将在第五章中讨论这一问题。}。这一分解方式的原理在于：我们相信供给方的通过其收集的大量用户数据，可以根准确地估计点击率；而转化效果是广告商站内的行为，当然他们自己的数据分析体系更能够准确地对其作出评估。

三、CPS(Cost per Sale)/CPA(Cost per Action)/ROI计费，即按照销售订单数、转化行为数或投入产出比来计费，而这些都是按照转化付费的一些变种。应该说这是一种极端的情况，即需求方只按照最后的转化收益来结算，从而极大程度上规避了风险。在这种计费方式下，供给方或中间市场除了估计点击率，还要对点击价值作出估计，才能合理地决定流量分配。这一方式存在两个很明显的问题：一是转化行为并非供给方能够控制，因此也无法进行准确的估计和优化。只有那些转化流程和用户体验相似的广告商组成的广告网络，按转化付费才比较合理，典型的例子比如淘宝直通车；二是存在广告主故意降低转化率，以低成本赚取大量品牌曝光的可能。因此，我们认为这种方式只适合于一些\begin{CJK*}{GBK}{kai}{垂直广告网络(Vertical Network)}\end{CJK*}。另外在DSP中，由于需要完全代表广告主利益出价和优化，因此也经常会出现跟广告主之间按照CPS计费的情形。

四、CPT(Cost per Time)计费，这是针对大品牌广告主特定的广告活动，将某个广告位以独占式方式交给某广告主，并按独占的时间段收取费用的方式。严格来说这是一种销售方式，而非一种计价模式，因为价格是双方事先约定，无需计量。这种方式在欧美市场并非经常采用，不过在中国的门户网站广告中是一种主流模式。CPT还有一种变形，即轮播式CPT，它是将某一广告位的流量按照某一cookie接触到的次数划分成多轮，在其中的若干轮独占式售卖给某广告主，这同样是中国市场很常见的一种售卖方式。CPT这样独占式的售卖虽然有一些额外的品牌效果和橱窗效应产生，但是非常不利于受众定向和程序交易的发展，因而长期看来比例会有下降的趋势。

综合起来看，可以认为对于效果广告，CPC计费方式最有利于发挥供给方和需求方的长处，因而在市场上被广泛接受。而对于品牌广告，由于效果和目的有时不便于直接衡量，可以考虑按照CPM的方式计费。而CPS的计费方式，只在一些特定的环境下才比较合理。

\subsection{广告算法核心任务――如何量化展示价值}
公式\ref{opt}描述的计算广告核心问题，从算法优化与系统架构两个角度看，分别面临着不同的挑战，也可以进一步分解成一些相对具体的课题，或者从其他相关的研究和工业实践中寻找解决方案，或者在没有合适的方案时做具体探索。

从算法优化的角度看，该问题的特征提取，即对$a,u,c$ 打标签以方便挖掘的技术，对应产生了\begin{CJK*}{GBK}{kai}{受众定向}\end{CJK*}问题；如果不考虑全局最优，则主要依靠\begin{CJK*}{GBK}{kai}{eCPM估计}\end{CJK*}，特别是\begin{CJK*}{GBK}{kai}{CTR预测}\end{CJK*}来完成每一次展示时的局部优化；如果考虑到量的限制和投放时即时决策的要求，就产生了\begin{CJK*}{GBK}{kai}{在线分配}\end{CJK*}的问题；为了在多方博弈的市场中达到动态平衡时的收益最大化，则需要对\begin{CJK*}{GBK}{kai}{定价策略}\end{CJK*}做深入研究；为了更全面地采样整个$(a,u,c)$ 的空间以便更准确地估计点击率，需要用到强化学习(Reinforcement Learning) 中的\begin{CJK*}{GBK}{kai}{探索与利用(Explore and Exploit, E\&E)}\end{CJK*}算法；而在DSP快速发展的今天，\begin{CJK*}{GBK}{kai}{推荐算法}\end{CJK*}也被广泛使用在个性化重定向当中。

从系统架构的角度看，我们需要用到\begin{CJK*}{GBK}{kai}{实时索引}\end{CJK*}技术服务于广告候选的检索；用到No-SQL的在线存储技术为投放时提供用户、上下文标签和其他特征；大量使用Hadoop这样的\begin{CJK*}{GBK}{kai}{分布式计算}\end{CJK*}平台进行大规模数据挖掘；用到最新的\begin{CJK*}{GBK}{kai}{流计算}\end{CJK*}平台实现短时用户行为反馈；以及在广告交易环境下实现高并发、快速响应的的\begin{CJK*}{GBK}{kai}{实时竞价}\end{CJK*}接口；还需要许多有关HTML协议和前端展示的技术来完成广告的具体投放。

上述的这些技术，与一般意义下的通用技术即有联系，但也有很多独特之处。我们将会在介绍具体的广告产品时，再结合相应的上下文讨论这些技术。关于在这些技术中经常用到的一些基础知识，我们也将在本章的最后一部分做概要的介绍。

当然，本书并不是专门讨论机器学习或信息检索的教程，因此大家不要期许在这里能系统地学习到这些领域的知识。我们的目标是从商业逻辑产生的需求出发，深入解剖问题的本质，并给出一些代表性的解决方案。同时，在借用到其他工业事件中已经成熟的技术时，会尽量通过分析具体问题给出建议性的方案，同时也会对相关背景做概述以方便大家进一步深入了解。

\section{计算广告系统架构}
我们根据上面对广告核心问题的描述，以及主要技术课题的分解，抽象出一个完整的广告系统可能具备的各个模块，以及这些模块之间的协作关系，并将这些用图\ref{Arch}
中的架构框架来描述，这一架构图将是我们后面讨论各种广告产品系统结构的统一基础。因此，我们也讨论具体的广告技术前，先对架构图的各部分做一些概念解释。
\begin{figure}
\centering
\scalebox{0.6}
{
    \includegraphics[width=1.65\textwidth]{Architect.eps}
}
\caption{在线广告系统一般性架构示意}\label{Arch}
\end{figure}

整体上来看，图\ref{Arch}中的广告系统由三个主体部分构成：一个是在线的高并发投放引擎(Ad server)，一个是离线的分布式数据处理平台(Grid)，另一个是用于在线实时反馈的流式处理平台(Stream computing)。这三部分各司其职，配合完成整个计算广告的数据挖掘和在线投放任务。下面我们来看看按遵照功能划分，这个系统中都有哪些重要的模块：

一、广告投放机，即图中的Ad server。这是接受广告前端Web server发来的请求，完成广告投放决策并返回最后页面片段的主逻辑。我们可以将它类比于人体的躯体。广告投放机的主要任务是与其他各个功能性模块打交道，并将他们串联起来完成在线广告投放决策。一般来说，为了扩展性的考虑，我们都采用类搜索的投放机架构，即先通过倒排索引从大量的广告候选中等到少量符合条件的或相关的候选，再在这个小的候选集上应用复杂而精确的排序方法找到综合收益最高的若干个广告。对广告投放机来说，最重要的指标是能同时处理的并发数，以及广告决策的延迟。

二、广告检索，包括图中的Ad index和Ad retrieval两部分。这部分功能，可以类比于人体的心脏，它主要的功能，是实时接受广告投放信息，建立倒排索引，以及在线时根据用户与上下文标签从索引中查找广告候选。实际上，检索技术的重要性体现在所有Web-scale的技术挑战上，也同样是大规模计算广告系统的基础。

三、广告排序，包括图中的Ad ranking和Click modeling两部分。这部分可以类比于人体的大脑，因为它是广告效果优化的关键。其关键技术，在于离线分布式计算平台上的海量数据支持的点击率预测模型的训练。当然线上如何高查询模型需要的特征并进行高效计算，也是非常关键的。另外，在需要估计点击价值的广告产品中，我们还需要一个点击价值估计的模型，或者一些简单的规则，但是不像点击率预测那样有较为稳定统一的建模方法，因此我们在这里主要强调Click modeling。

四、数据高速公路，即图中的Data highway。这部分完成的功能，是将在线投放的数据准实时传输到离线分布式计算平台与流式计算平台上，供后续处理和建模使用，它可以类比于人体的循环系统。由于在进行受众定向建模时，需要用到广告系统以外的其他用户日志数据或第三方合作数据，因此数据高速公路也担负着收集这些数据源的任务。

五、用户日志生成，即图中的Session log generation。从各个渠道收集来日志，需要先整理成以用户ID为key的统一存储格式，我们把这样的日志称为用户日志(Session log)。这样整理的目的。是为了让后续的受众定向过与程更加简单高效\footnote{关于为什么要这样做，可以参照第四章中行为定向部分中的讨论。}。

六、商业智能(Business Intelligence，BI)系统，包括ETL(Extract-Transform-Load)过程, Dashboard和Cube。这些是所有以人为最终接口的数据处理和分析流程的总括。因为它担负着对外信息交流的任务，可以类比于人的嘴。由于实际的广告运营不可能完全通过机器的决策来进行，其间必然需要有经验的操作者根据数据反馈对一些系统设置做及时调整。因此，实现一个功能强大，交互便利的BI系统是非常重要的。

七、行为定向，包括结构化标签库(Structural label base), Audience targeting, 以及User attributes的cache：这部分完成的是挖掘用户日志，根据日志中的行为给用户打上结构化标签库中某些标签的过程。这部分是计算广告的原材料加工厂，相当于人体的胃，也因此在整个系统中具有非常关键的地位。

八、上下文定向，包括半在线页面抓取(Near-line page fetcher)和Page attributes的cache：这部分与行为定向互相配合，负责给上下文页面打上标签，用于在线的广告投放中。这里的抓取系统比搜索系统要简单，但也有不太一样的需求，我们后面会介绍到。

九、定制化用户划分，即图中的Customized audience segmentation：由于广告是媒体替广告主完成用户接触，那么有时需要根据广告主的逻辑来划分用户群，这部分也是具有鲜明广告特色的模块。这个部分指的是从广告主处收集用户信息的产品接口，而收集到的数据如果需要较复杂的加工，也将经过数据高速公路导入受众定向模块来完成。这这是广告独特的功能模块，推荐系统和搜索系统是不需要这一功能的。

十、在线行为反馈：这部分指的是一些需要准实时完成的一些任务，包括短时的用户行为标签和短时用户点击反馈等。当然，在利用日志完成这些逻辑之前，必须要进行的步骤是反作弊(Anti-spam)与计价(Billing)。为了组织这样一些前后有依赖关系的数据流加工过程，我们经常选用流式管理平台作为基础设施。需要特别指出，这一部分对于在线广告系统的效果提升意义重大：在很多情形下，把系统信息反馈调整做得更快，比把模型预测做得更准确效果更加显著。

十一、广告管理系统：这部分是广告操作者，即客户执行(Account execute, AE)与广告系统的接口，AE通过广告管理系统定制和调整广告投放，并且与数据仓库交互，获得投放统计数据以支持决策。一般来说，广告系统中只有这部分是面向用户的产品。根据对操作对象开放程度的不同，这一系统有时又有开放自助的需求，在这种情况下，还需要包含相应的财务结算功能。对这部分，读者可以从很多自助式广告产品，比如Adsense，的投放界面中了解这部分的功能，我们在本书中将不做重点讨论。

十二、实时竞价接口：这是广告交易市场实时向DSP发起广告询价请求，并根据竞价结果胜出DSP的程序交易接口。它包括作为需求方时使用的RTBS(RTB for Supply)，以及作为供给方时使用的RTBD(RTB for Demand)。这也是一个广告系统特有的功能模块，在程序化交易原来越流行的今天是广告系统很重要的功能之一。

实际上，并不是每一个广告系统都需要以上所有的功能模块。这样的架构图和模块划分，是为了后文比较容易在各种类型的广告系统之间做架构上的对比。另外需要说明，这样一架构描述，主要是根据竞价广告系统的骨架来进行的，对于其他类型的广告系统，虽然概念上也可以套用，可以术语和习惯上并不直接。为了行文的方便和一致性，本书还是会在这一总架构的基础上讨论各种广告系统。

\clearpage{\pagestyle{empty}} %\cleardoublepage

\end{CJK*}
